<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>CSVLayer</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.15/esri/themes/dark-red/main.css"
    />

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        background-color: black;
      }
    </style>

    <script src="https://js.arcgis.com/4.15/"></script>

    <script>
      require([
      "esri/geometry/geometryEngine",
        "esri/layers/FeatureLayer",
        "esri/layers/CSVLayer",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/tasks/support/Query",
        "esri/Map",
        "esri/views/MapView",
        "esri/tasks/GeometryService",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "esri/symbols/SimpleFillSymbol",
        "esri/tasks/support/FeatureSet",
        "esri/widgets/Legend",
        "esri/widgets/Expand"
      ], function(geometryEngine, FeatureLayer, CSVLayer, SimpleMarkerSymbol, Query, Map, MapView, GeometryService, Graphic, GraphicsLayer, SimpleFillSymbol, FeatureSet, Legend, Expand) {
        var geomservice= new GeometryService({
          url: "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Utilities/Geometry/GeometryServer"
        })
        
        var map1= new Map({
          basemap: 'streets'
        });

        var view = new MapView({
          map: map1,  // References a Map instance
          container: "viewDiv"  // References the ID of a DOM element
        });
        view.center = [-59.558614, 13.172762];  // Sets the center point of the view at a specified lon/lat 
        view.zoom = 11;  // Sets the zoom LOD to 10

        var boundary= new FeatureLayer({
          url:"https://services2.arcgis.com/j80Jz20at6Bi0thr/arcgis/rest/services/barbados_boundary/FeatureServer/0"
        })

        const url =
          "https://alishadsilva.github.io/csvlayer/Metadata_spec_v2.csv"; 
        
        var csvLayer = new CSVLayer({
          url:url
        });

        var test=new GraphicsLayer()
        var graphicsLayer = new GraphicsLayer();

        outage_num=[]

        // csvLayer.load().then(function(){
          boundary.queryFeatures().then(function(evt){
            var boundarygeom= evt.features[0].geometry
          console.log(boundarygeom)
          

          csvLayer.queryFeatures().then(function(event){
            for (var i = 0; i < event.features.length; i++) {
              if(!outage_num.includes(event.features[i].attributes.Outage_Number)){
                outage_num.push(event.features[i].attributes.Outage_Number)
              }
            }
            console.log(outage_num)
            outage_num.forEach(function(evt){
              console.log(evt)
              var query1= new Query({
                where: "Outage_Number=" + evt,
                returnGeometry: true
                })
                return csvLayer.queryFeatures(query1).then(function(points){ 
                  console.log(points)
                  var geom=[]
                  for (y of points.features){
                    if (geometryEngine.contains(boundarygeom,y.geometry)){
                      geom.push(y.geometry)
                      var pointsgraphic= new Graphic({
                      geometry: y.geometry,
                      attributes: y.attributes,
                      symbol:{
                      type:"simple-marker",
                      style: "x",
                      size: 5,
                      outline: { color: [251, 9, 9, 1] },
                      color: [253, 203, 203, 0.25]
                    }
                    })
                    test.add(pointsgraphic)
                    }
                    }
                    console.log(test)
                    // var  geom= test.graphics.items.map(function(item){
                    //   return item.geometry
                    //   console.log(item.geometry)
                    //   })
                      geomservice.convexHull(geom).then(function(result1){
                        var simpleFillSymbol = {
                          type: "simple-fill",
                          color: [227, 139, 79, 0.1],  // orange, opacity 10%
                          outline: {
                          color: [145, 29, 0],
                          width: 1
                          }
                        };

                    var polygonGraphic = new Graphic({
                      geometry: result1,
                      symbol: simpleFillSymbol
                      });
                    graphicsLayer.add(polygonGraphic)
                    map1.add( graphicsLayer)
                    geom=[]
                    if (outage_num.length==1){
                      view.extent=polygonGraphic.geometry.extent
                      view.zoom= view.zoom - 1
                    }
                  })
                }) // csvlayer qf1 end
                }) //for loop end
                // })//csv layer qf.then end
            }) // csvlayer qf end
            map1.add(test)
            console.log(test)
          }) //boundary qf end
        // }) //load func end

        })

    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
